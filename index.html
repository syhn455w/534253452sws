<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>çš®å…‹æ•è˜‘è‡ PWA Pro</title>
    
    <!-- PWA Meta -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#16a34a" id="theme-color-meta">
    <link rel="apple-touch-icon" href="https://www.pikminbloom.com/favicon.ico">
    <link rel="manifest" id="pwa-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'bounce-subtle': 'bounce-subtle 2s infinite',
                    },
                    keyframes: {
                        'bounce-subtle': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root { --safe-area-inset-top: env(safe-area-inset-top); }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s;
            /* é˜²æ­¢æ•´é«”é é¢éåº¦æ‹‰ä¼¸ */
            overscroll-behavior-y: none;
        }

        /* é–å®šèƒŒæ™¯æ²å‹•çš„æ¨£å¼ */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        .app-gradient { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); }
        .dark .app-gradient { background: linear-gradient(135deg, #064e3b 0%, #022c22 100%); }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* æ»¾è¼ªé¸æ“‡å™¨å„ªåŒ–ï¼šé˜²æ­¢æŠ–å‹•èˆ‡éš”é›¢æ²å‹• */
        .picker-container {
            position: relative;
            height: 160px;
            overflow: hidden;
            display: flex;
            background: rgba(0,0,0,0.03);
            border-radius: 1.5rem;
            mask-image: linear-gradient(to bottom, transparent, black 40%, black 60%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 40%, black 60%, transparent);
            /* é—œéµï¼šé˜²æ­¢æ»‘å‹•åŠ›é‡å‚³éåˆ°èƒŒæ™¯ */
            overscroll-behavior: contain;
        }
        .dark .picker-container { background: rgba(255,255,255,0.05); }

        .picker-column {
            flex: 1;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            padding: 55px 0;
            /* å„ªåŒ–ç§»å‹•ç«¯æ»‘å‹•æ„Ÿ */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-y;
        }
        .picker-column::-webkit-scrollbar { display: none; }

        .picker-item {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: center;
            font-size: 1.25rem;
            font-weight: 900;
            color: #94a3b8;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .picker-item.active { color: #16a34a; transform: scale(1.15); }
        .dark .picker-item.active { color: #4ade80; }

        .picker-center-bar {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; height: 50px;
            border-top: 1px solid rgba(22, 163, 74, 0.2);
            border-bottom: 1px solid rgba(22, 163, 74, 0.2);
            pointer-events: none;
        }

        .mush-icon-btn {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .mush-icon-btn.selected {
            border-color: #16a34a;
            transform: scale(1.1);
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .dark .mush-icon-btn.selected { background: #1e293b; border-color: #4ade80; }
    </style>
</head>
<body class="min-h-screen pb-20 bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100">

    <!-- Header -->
    <header class="app-gradient text-white px-6 pb-12 rounded-b-[3.5rem] shadow-2xl sticky top-0 z-40 transition-all">
        <div class="max-w-md mx-auto flex justify-between items-center" style="padding-top: calc(var(--safe-area-inset-top) + 1.5rem);">
            <div>
                <h1 class="text-2xl font-black tracking-tight flex items-center gap-2">
                    <span class="text-3xl animate-bounce-subtle">ğŸ„</span> çš®å…‹æ•è¨ˆæ™‚ Pro
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="pwa-status" class="w-2.5 h-2.5 rounded-full bg-red-400"></span>
                    <p id="status-text" class="text-green-100 text-xs font-medium opacity-80">é€šçŸ¥æª¢æŸ¥ä¸­...</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleDarkMode()" class="bg-white/10 p-3 rounded-2xl border border-white/20 active:scale-90 transition-all">
                    <svg id="dark-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M17.657 17.657l.707.707M6.343 6.343l.707-.707M14.5 12a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                    </svg>
                </button>
                <button onclick="toggleAddModal()" class="bg-white text-green-600 p-3 rounded-2xl shadow-xl active:scale-90 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 -mt-8 space-y-4">
        <!-- PWA å®‰è£æç¤º -->
        <div id="pwa-install-banner" class="hidden bg-indigo-600 text-white p-5 rounded-[2rem] shadow-xl flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="text-3xl">ğŸ“±</div>
                <div class="text-xs font-bold leading-tight text-pretty pr-2">å®‰è£åˆ°ä¸»ç•«é¢<br><span class="opacity-80 font-normal text-[10px]">é‡ç”Ÿå‰ 20 ç§’ç²¾æº–æé†’</span></div>
            </div>
            <button id="install-button" class="bg-white text-indigo-600 px-5 py-2 rounded-full text-xs font-black flex-shrink-0">ç«‹å³å®‰è£</button>
        </div>

        <!-- è¨ºæ–·å€åŸŸ -->
        <div id="diag-banner" class="bg-white dark:bg-slate-900 p-4 rounded-[2rem] shadow-sm border border-slate-200 dark:border-slate-800 space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ç³»çµ±è¨ºæ–·</span>
                <span id="perm-label" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500">æª¢æŸ¥ä¸­</span>
            </div>
            <button onclick="requestNotificationPermission()" id="perm-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-2xl text-xs font-bold shadow-md active:scale-95 transition-all hidden">
                é»æ­¤æˆæ¬Šé€šçŸ¥æ¬Šé™
            </button>
        </div>

        <!-- è¨ˆæ™‚æ¸…å–® -->
        <div id="empty-state" class="py-24 text-center space-y-4 opacity-30">
            <div class="text-6xl">âœ¨</div>
            <p class="font-bold">ç›®å‰æ²’æœ‰è¿½è¹¤ä¸­çš„è˜‘è‡</p>
        </div>

        <div id="mushroom-list" class="grid gap-4"></div>
    </main>

    <!-- æ–°å¢å½ˆçª— -->
    <div id="add-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-black/70 backdrop-blur-md hidden">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[3rem] p-8 space-y-6 shadow-2xl transition-all mb-safe">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black text-slate-800 dark:text-slate-100">è¿½è¹¤æ–°è˜‘è‡</h2>
                <button onclick="toggleAddModal()" class="text-slate-300 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            
            <div class="space-y-6">
                <!-- è˜‘è‡é¡è‰²é¸æ“‡å™¨ -->
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é¸æ“‡è˜‘è‡é¡è‰²</label>
                    <div class="flex justify-between bg-slate-50 dark:bg-slate-800 p-3 rounded-3xl" id="color-picker">
                        <button onclick="selectColor('red', 'ğŸ”´')" class="mush-icon-btn selected" data-color="red">ğŸ”´</button>
                        <button onclick="selectColor('yellow', 'ğŸŸ¡')" class="mush-icon-btn" data-color="yellow">ğŸŸ¡</button>
                        <button onclick="selectColor('blue', 'ğŸ”µ')" class="mush-icon-btn" data-color="blue">ğŸ”µ</button>
                        <button onclick="selectColor('purple', 'ğŸŸ£')" class="mush-icon-btn" data-color="purple">ğŸŸ£</button>
                        <button onclick="selectColor('white', 'âšª')" class="mush-icon-btn" data-color="white">âšª</button>
                        <button onclick="selectColor('gray', 'ğŸ”˜')" class="mush-icon-btn" data-color="gray">ğŸ”˜</button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">åœ°é»åç¨± (é¸å¡«)</label>
                    <input type="text" id="input-label" placeholder="ä¾‹å¦‚ï¼šæ·é‹ç«™ã€å…¬åœ’å…¥å£" class="w-full p-4 bg-slate-50 dark:bg-slate-800 border-2 border-transparent rounded-2xl focus:border-green-500 outline-none font-bold text-sm">
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-center px-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">å‰©é¤˜æˆ°é¬¥æ™‚é–“</label>
                        <div class="flex gap-2">
                            <button onclick="adjustWheel('h', 1)" class="text-[10px] bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-md font-bold">+1æ™‚</button>
                            <button onclick="adjustWheel('m', 10)" class="text-[10px] bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-md font-bold">+10åˆ†</button>
                        </div>
                    </div>
                    <div class="picker-container">
                        <div class="picker-center-bar"></div>
                        <div id="wheel-h" class="picker-column"></div>
                        <div id="wheel-m" class="picker-column"></div>
                        <div id="wheel-s" class="picker-column"></div>
                    </div>
                </div>

                <button onclick="addMushroom()" class="w-full bg-green-600 text-white font-black py-5 rounded-[2rem] shadow-xl active:scale-95 transition-all text-lg">é–‹å§‹è¿½è¹¤ (5åˆ†é‡ç”Ÿ)</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900/90 dark:bg-slate-100/90 text-white dark:text-slate-900 px-8 py-3 rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-50 text-sm font-bold text-center">å·²æ›´æ–°</div>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        let mushrooms = [];
        let swRegistration = null;
        let wakeLock = null;
        let selectedTime = { h: 0, m: 0, s: 0 };
        let currentMushroomColor = { id: 'red', emoji: 'ğŸ”´' };

        // 1. åˆå§‹åŒ–
        window.onload = () => { 
            initDarkMode();
            initSW(); 
            initWheels();
            loadData(); 
            renderList(); 
            startTicker(); 
        };

        // æ·±è‰²æ¨¡å¼åˆ‡æ›
        function initDarkMode() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                updateThemeIcon(true);
            }
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'theme';
            updateThemeIcon(isDark);
        }

        function updateThemeIcon(isDark) {
            const icon = document.getElementById('dark-icon');
            const meta = document.getElementById('theme-color-meta');
            if (isDark) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M17.657 17.657l.707.707M6.343 6.343l.707-.707M14.5 12a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />';
                meta.setAttribute('content', '#022c22');
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
                meta.setAttribute('content', '#16a34a');
            }
        }

        // PWA Manifest
        const manifest = {
            "name": "çš®å…‹æ•è˜‘è‡è¨ˆæ™‚ Pro",
            "short_name": "è˜‘è‡è¨ˆæ™‚",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f8fafc",
            "theme_color": "#16a34a",
            "icons": [{ "src": "https://www.pikminbloom.com/favicon.ico", "sizes": "192x192", "type": "image/png" }]
        };
        document.getElementById('pwa-manifest').setAttribute('href', 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest)));

        // æ»‘å‹•è¼ªåˆå§‹åŒ–
        function initWheels() {
            createWheel('wheel-h', 24, 'h');
            createWheel('wheel-m', 60, 'm');
            createWheel('wheel-s', 60, 's');
        }

        function createWheel(id, count, type) {
            const el = document.getElementById(id);
            let html = '';
            for(let i=0; i<count; i++) html += `<div class="picker-item" data-val="${i}">${String(i).padStart(2, '0')}</div>`;
            el.innerHTML = html;

            el.addEventListener('scroll', () => {
                const index = Math.round(el.scrollTop / 50);
                if (selectedTime[type] !== index && index < count) {
                    selectedTime[type] = index;
                    el.querySelectorAll('.picker-item').forEach((item, i) => {
                        item.classList.toggle('active', i === index);
                    });
                    // æ»‘å‹•æ™‚å¾®éœ‡å‹•å›é¥‹
                    if (navigator.vibrate) navigator.vibrate(5);
                }
            }, { passive: true });

            // é˜²æ­¢æ»¾å‹•å†’æ³¡åˆ°èƒŒæ™¯
            el.addEventListener('touchmove', (e) => {
                e.stopPropagation();
            }, { passive: true });

            setTimeout(() => { el.querySelectorAll('.picker-item')[0].classList.add('active'); }, 100);
        }

        function adjustWheel(type, amount) {
            const el = document.getElementById(`wheel-${type}`);
            const current = selectedTime[type];
            const max = type === 'h' ? 24 : 60;
            const target = (current + amount) % max;
            el.scrollTo({ top: target * 50, behavior: 'smooth' });
        }

        function selectColor(id, emoji) {
            currentMushroomColor = { id, emoji };
            document.querySelectorAll('.mush-icon-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.color === id);
            });
            if (navigator.vibrate) navigator.vibrate(10);
        }

        async function initSW() {
            if ('serviceWorker' in navigator) {
                try {
                    const swCode = `
                        self.addEventListener('install', e => self.skipWaiting());
                        self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                        self.addEventListener('notificationclick', e => {
                            e.notification.close();
                            e.waitUntil(clients.matchAll({type: 'window'}).then(c => c.length > 0 ? c[0].focus() : clients.openWindow('/')));
                        });
                    `;
                    const blob = new Blob([swCode], { type: 'text/javascript' });
                    swRegistration = await navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(err => {
                        return null;
                    });
                } catch (e) {}
            }
            updateUIStatus();
        }

        function updateUIStatus() {
            const statusDot = document.getElementById('pwa-status');
            const statusText = document.getElementById('status-text');
            const permLabel = document.getElementById('perm-label');
            const permBtn = document.getElementById('perm-btn');

            if (Notification.permission === "granted") {
                statusDot.className = "w-2.5 h-2.5 rounded-full bg-green-400 shadow-[0_0_10px_rgba(74,222,128,0.6)]";
                statusText.innerText = swRegistration ? "èƒŒæ™¯ç›£æ§é‹ä½œä¸­" : "å‰å°ç›£æ§é‹ä½œä¸­";
                permLabel.innerText = "å·²æˆæ¬Šé€šçŸ¥";
                permLabel.className = "text-[10px] font-bold px-2 py-0.5 rounded-full bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300";
                permBtn.classList.add('hidden');
            } else {
                statusDot.className = "w-2.5 h-2.5 rounded-full bg-red-400 animate-pulse";
                statusText.innerText = "éœ€é–‹å•Ÿé€šçŸ¥æ¬Šé™";
                permLabel.innerText = "æ¬Šé™å—é™";
                permLabel.className = "text-[10px] font-bold px-2 py-0.5 rounded-full bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300";
                permBtn.classList.remove('hidden');
            }
        }

        async function requestNotificationPermission() {
            const p = await Notification.requestPermission();
            updateUIStatus();
            if (p === "granted") {
                showToast("é€šçŸ¥æ¬Šé™å·²é–‹å•Ÿ");
                testNotification(); 
            }
        }

        function testNotification() {
            triggerNotification({ label: "æ¸¬è©¦æé†’", iconEmoji: "ğŸ„", id: "test" }, true);
        }

        function addMushroom() {
            const labelText = document.getElementById('input-label').value.trim();
            const label = labelText || `${currentMushroomColor.id}è˜‘è‡`;
            const { h, m, s } = selectedTime;
            
            // é‡ç”Ÿè¨ˆç®—ï¼šæˆ°é¬¥æ™‚é–“ + 300 ç§’ (5 åˆ†é˜)
            const waitSec = (h * 3600) + (m * 60) + s + 300;
            const spawnAt = Date.now() + (waitSec * 1000);

            mushrooms.push({ 
                id: Date.now(), 
                label, 
                iconEmoji: currentMushroomColor.emoji,
                spawnAt, 
                notified: false 
            });
            saveData();
            renderList();
            toggleAddModal();
            showToast(`å·²é–å®šï¼š${currentMushroomColor.emoji} ${label} (5åˆ†é‡ç”Ÿ)`);
            requestWakeLock();
        }

        function triggerNotification(m, isTest = false) {
            const title = isTest ? "ğŸ„ é€šçŸ¥åŠŸèƒ½æ­£å¸¸" : `${m.iconEmoji} è˜‘è‡å³å°‡é‡ç”Ÿï¼`;
            const body = isTest ? "ç¾åœ¨æ‚¨å¯ä»¥æ”¾å¿ƒå»å¿™åˆ¥çš„äº‹äº†ã€‚" : `åœ°é»ï¼š${m.label}\nå€’æ•¸ 20 ç§’å‡ºç¾ï¼Œå¿«å»ä½”ä½ï¼`;
            
            const sound = document.getElementById('notif-sound');
            if (sound) { sound.currentTime = 0; sound.play().catch(() => {}); }

            if (Notification.permission === "granted") {
                if (swRegistration && swRegistration.showNotification) {
                    swRegistration.showNotification(title, { body, icon: "https://www.pikminbloom.com/favicon.ico", badge: "https://www.pikminbloom.com/favicon.ico", vibrate: [200, 100, 200] });
                } else {
                    try { new Notification(title, { body }); } catch (e) {}
                }
            }
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }

        function renderList() {
            const container = document.getElementById('mushroom-list');
            const empty = document.getElementById('empty-state');
            if (mushrooms.length === 0) { empty.classList.remove('hidden'); container.innerHTML = ""; return; }
            empty.classList.add('hidden');

            mushrooms.sort((a,b) => a.spawnAt - b.spawnAt);
            container.innerHTML = mushrooms.map(m => {
                const isOver = Date.now() > m.spawnAt;
                return `
                    <div class="glass-card p-6 rounded-[2.5rem] shadow-sm relative overflow-hidden card-enter border-l-4" style="border-left-color: ${getHex(m.iconEmoji)}">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] px-3 py-1 rounded-full font-black ${isOver ? 'bg-slate-200 dark:bg-slate-800 text-slate-400' : 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400'}">
                                ${isOver ? 'é‡ç”Ÿå®Œæˆ' : 'ç›£æ§ä¸­'}
                            </span>
                            <button onclick="deleteMushroom(${m.id})" class="text-slate-300 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                        </div>
                        <h3 class="font-black text-slate-800 dark:text-slate-100 text-xl truncate pr-10">
                            <span class="mr-2">${m.iconEmoji}</span>${m.label}
                        </h3>
                        <p class="text-xs font-bold text-slate-400 mt-1">é è¨ˆé‡ç”Ÿï¼š${new Date(m.spawnAt).toLocaleTimeString('zh-TW', {hour12:false})}</p>
                        <div class="mt-4">
                            <span id="t-${m.id}" class="font-mono text-4xl font-black ${isOver ? 'text-slate-200 dark:text-slate-800' : 'text-red-500'} tracking-tighter">
                                ${getRemaining(m.spawnAt)}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getHex(emoji) {
            const colors = { 'ğŸ”´':'#ef4444', 'ğŸŸ¡':'#eab308', 'ğŸ”µ':'#3b82f6', 'ğŸŸ£':'#a855f7', 'âšª':'#cbd5e1', 'ğŸ”˜':'#64748b' };
            return colors[emoji] || '#16a34a';
        }

        function getRemaining(target) {
            const diff = target - Date.now();
            if (diff <= 0) return "REBORN";
            const s = Math.floor(diff / 1000);
            return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
        }

        function startTicker() {
            setInterval(() => {
                const now = Date.now();
                mushrooms.forEach(m => {
                    const el = document.getElementById(`t-${m.id}`);
                    if (el) el.innerText = getRemaining(m.spawnAt);
                    if (!m.notified && (m.spawnAt - now) <= 20000 && (m.spawnAt - now) > 0) {
                        m.notified = true;
                        triggerNotification(m);
                        saveData();
                    }
                });
            }, 1000);
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator && mushrooms.some(m => m.spawnAt > Date.now())) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
            }
        }

        function toggleAddModal() {
            const modal = document.getElementById('add-modal');
            const isOpen = modal.classList.toggle('hidden');
            if (!isOpen) {
                document.body.classList.add('modal-open');
                // ä¿®æ­£ iOS ä¸‹é–å®šèƒŒæ™¯å¾Œå¯èƒ½ç™¼ç”Ÿçš„ä½ç½®åç§»å•é¡Œ
                document.body.style.top = `-${window.scrollY}px`;
            } else {
                const scrollY = document.body.style.top;
                document.body.classList.remove('modal-open');
                document.body.style.top = '';
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }
        }

        function deleteMushroom(id) { mushrooms = mushrooms.filter(m => m.id !== id); saveData(); renderList(); }
        function saveData() { localStorage.setItem('pm_pro_data', JSON.stringify(mushrooms)); }
        function loadData() {
            const d = localStorage.getItem('pm_pro_data');
            if (d) {
                try { mushrooms = JSON.parse(d).filter(m => m.spawnAt > (Date.now() - 86400000)); } catch(e) { mushrooms = []; }
            }
        }
        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        }

        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') requestWakeLock(); });
    </script>
</body>
</html>
