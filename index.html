<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è˜‘è‡å¤§å¸« Master Pro</title>
    
    <!-- PWA Meta -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#10b981" id="theme-color-meta">
    <link rel="apple-touch-icon" href="https://www.pikminbloom.com/favicon.ico">
    <link rel="manifest" id="pwa-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#10b981', 600: '#059669', 900: '#064e3b' }
                    },
                    borderRadius: { '4xl': '2rem', '5xl': '2.5rem' },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'slide-up': 'slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        'slide-up': { 'from': { transform: 'translateY(100%)', opacity: '0' }, 'to': { transform: 'translateY(0)', opacity: '1' } },
                        shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { --safe-area-inset-top: env(safe-area-inset-top); }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f8fafc; 
            overscroll-behavior-y: none;
            transition: background-color 0.3s ease;
        }

        /* ä¿®æ­£ iOS èƒŒæ™¯é–å®šåç§»çš„é—œéµ CSS */
        body.modal-open { 
            overflow: hidden; 
            position: fixed; 
            width: 100%; 
            height: 100%;
        }

        .premium-bg { background: linear-gradient(165deg, #10b981 0%, #059669 100%); }
        .dark .premium-bg { background: linear-gradient(165deg, #064e3b 0%, #022c22 100%); }
        .premium-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }

        /* æ»¾è¼ªé¸æ“‡å™¨çµ„ä»¶ */
        .picker-container {
            position: relative;
            height: 180px;
            overflow: hidden;
            display: flex;
            background: rgba(241, 245, 249, 0.8);
            border-radius: 2rem;
            mask-image: linear-gradient(to bottom, transparent, black 45%, black 55%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 45%, black 55%, transparent);
            overscroll-behavior: contain;
        }
        .dark .picker-container { background: rgba(30, 41, 59, 0.5); }

        .picker-column { 
            flex: 1 0 33.33%; 
            overflow-y: scroll; 
            overflow-x: hidden; 
            scroll-snap-type: y mandatory; 
            scrollbar-width: none; 
            -webkit-overflow-scrolling: touch; 
            overscroll-behavior: contain; 
            touch-action: pan-y; 
            padding: 65px 0; 
        }
        .picker-column::-webkit-scrollbar { display: none; }

        .picker-item { 
            height: 50px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            scroll-snap-align: center; 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: #94a3b8; 
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
            white-space: nowrap;
        }
        .picker-item.active { color: #10b981; transform: scale(1.2); font-weight: 900; }
        .dark .picker-item.active { color: #34d399; }

        .picker-center-indicator { 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            width: 85%; height: 50px; 
            background: rgba(16, 185, 129, 0.08); 
            border-radius: 12px; 
            pointer-events: none; 
        }

        /* åº•éƒ¨æŠ½å±œå‹•ç•«é‚è¼¯ */
        .drawer-content { 
            transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); 
            transform: translateY(100%); 
        }
        .modal-active .drawer-content { transform: translateY(0); }
        
        .progress-shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        /* è˜‘è‡åœ–ç¤ºé¸æ“‡æŒ‰éˆ• */
        .mush-icon-btn {
            width: 46px; height: 46px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
            transition: all 0.2s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            border: 2px solid transparent;
        }
        .mush-icon-btn.selected {
            border-color: #10b981;
            transform: scale(1.15);
            background: #fff;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }
        .dark .mush-icon-btn.selected { background: #1e293b; border-color: #34d399; }
    </style>
</head>
<body class="dark:bg-slate-950 text-slate-900 dark:text-slate-100">

    <div class="app-shell flex flex-col min-h-screen">
        <!-- é ‚éƒ¨ Headerï¼šæ”¯æ´å‹•æ…‹å³¶ -->
        <header class="premium-bg text-white px-6 pb-14 rounded-b-[4rem] shadow-2xl sticky top-0 z-30 transition-all overflow-hidden">
            <div class="max-w-md mx-auto" style="padding-top: calc(var(--safe-area-inset-top) + 1rem);">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-black tracking-tighter flex items-center gap-2">
                            <span class="animate-float">ğŸ„</span> è˜‘è‡å¤§å¸«
                        </h1>
                        <div id="status-badge" class="inline-flex items-center gap-2 px-3 py-1 bg-white/20 backdrop-blur-md rounded-full mt-2 transition-all cursor-pointer" onclick="toggleDiag()">
                            <span id="pwa-status-dot" class="w-2 h-2 rounded-full bg-red-400 shadow-sm"></span>
                            <span id="status-text" class="text-[10px] font-bold uppercase tracking-widest">ç³»çµ±æª¢æŸ¥ä¸­</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleDarkMode()" class="p-4 bg-white/10 hover:bg-white/20 rounded-3xl backdrop-blur-lg border border-white/10 active:scale-90 transition-all">
                            <svg id="dark-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ä¸»å…§å®¹æ¸…å–® -->
        <main class="max-w-md mx-auto w-full px-5 -mt-8 space-y-6 z-10 flex-grow pb-32">
            <!-- è¨ºæ–·å¡ç‰‡ -->
            <div id="diag-card" class="hidden bg-white/95 dark:bg-slate-900/95 backdrop-blur-2xl p-6 rounded-4xl border border-slate-200/50 dark:border-slate-800/50 premium-shadow animate-slide-up">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">æˆæ¬Šè¨ºæ–·ä¸­å¿ƒ</span>
                    <button onclick="toggleDiag()" class="text-slate-300 font-bold p-1">âœ•</button>
                </div>
                <p id="diag-info" class="text-xs font-medium text-slate-600 dark:text-slate-400 leading-relaxed"></p>
                <button onclick="requestNotificationPermission()" id="perm-btn" class="w-full mt-4 bg-brand-500 text-white py-4 rounded-2xl text-xs font-bold shadow-lg active:scale-95 transition-all">
                    ç«‹å³å•Ÿç”¨å®Œæ•´é€šçŸ¥æ¬Šé™
                </button>
            </div>

            <!-- å‹•æ…‹ç”Ÿæˆçš„åˆ—è¡¨ -->
            <div id="mushroom-list" class="grid gap-5"></div>

            <!-- ç©ºç‹€æ…‹æç¤º -->
            <div id="empty-state" class="hidden py-32 text-center space-y-4">
                <div class="relative inline-block">
                    <div class="absolute inset-0 bg-brand-500/20 blur-3xl rounded-full"></div>
                    <span class="relative text-7xl">ğŸƒ</span>
                </div>
                <p class="text-slate-400 font-bold tracking-tight">ç›®å‰æ²’æœ‰ç›£æ§ä¸­çš„è˜‘è‡<br><span class="text-[10px] font-medium opacity-60 uppercase tracking-widest mt-1 inline-block">Tap + to add new tracker</span></p>
            </div>
        </main>

        <!-- åº•éƒ¨ FAB -->
        <div class="fixed bottom-8 right-6 z-40">
            <button onclick="toggleAddModal()" class="w-20 h-20 bg-brand-500 text-white rounded-[2.2rem] flex items-center justify-center active:scale-90 transition-all shadow-2xl border-4 border-white dark:border-slate-900">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
            </button>
        </div>
    </div>

    <!-- æ–°å¢è˜‘è‡æŠ½å±œ (Master Pro ç²¾ä¿®ç‰ˆ) -->
    <div id="add-modal" class="fixed inset-0 z-50 flex items-end justify-center bg-slate-950/60 backdrop-blur-sm hidden transition-opacity">
        <div class="drawer-content bg-white dark:bg-slate-900 w-full max-w-lg rounded-t-[3.5rem] p-8 pb-14 shadow-2xl overflow-hidden relative">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-8"></div>
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-slate-800 dark:text-white tracking-tight">æ–°å¢è¿½è¹¤é …ç›®</h2>
                <button onclick="toggleAddModal()" class="w-10 h-10 bg-slate-100 dark:bg-slate-800 text-slate-400 rounded-full flex items-center justify-center active:scale-90 font-bold">âœ•</button>
            </div>

            <div class="space-y-6">
                <!-- æ™ºæ…§é è¨­ -->
                <div class="space-y-3">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å¿«é€Ÿé è¨­æˆ°é¬¥æ™‚é–“</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setPreset(3, 0, 0)" class="py-3 bg-slate-100 dark:bg-slate-800 rounded-2xl text-[10px] font-black hover:bg-brand-500 hover:text-white transition-all active:scale-95">3 æ™‚</button>
                        <button onclick="setPreset(6, 0, 0)" class="py-3 bg-slate-100 dark:bg-slate-800 rounded-2xl text-[10px] font-black hover:bg-brand-500 hover:text-white transition-all active:scale-95">6 æ™‚</button>
                        <button onclick="setPreset(12, 0, 0)" class="py-3 bg-slate-100 dark:bg-slate-800 rounded-2xl text-[10px] font-black hover:bg-brand-500 hover:text-white transition-all active:scale-95">12 æ™‚</button>
                        <button onclick="setPreset(23, 59, 59)" class="py-3 bg-slate-100 dark:bg-slate-800 rounded-2xl text-[10px] font-black hover:bg-brand-500 hover:text-white transition-all active:scale-95">1 å¤©</button>
                    </div>
                </div>

                <!-- é¡è‰²èˆ‡æ¨™ç±¤ -->
                <div class="space-y-3">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æ¨™ç±¤èˆ‡è˜‘è‡é¡å‹</label>
                    <input type="text" id="input-label" placeholder="ä¾‹å¦‚ï¼šå··å£ç´…è˜‘è‡" class="w-full p-5 bg-slate-50 dark:bg-slate-800/50 border-2 border-transparent rounded-4xl focus:border-brand-500 focus:bg-white dark:focus:bg-slate-800 outline-none font-bold text-lg transition-all">
                    <div class="flex justify-between bg-slate-50 dark:bg-slate-800/50 p-2 rounded-4xl border border-slate-100 dark:border-slate-800" id="color-picker">
                        <button onclick="selectColor('red', 'ğŸ”´')" class="mush-icon-btn selected" data-color="red">ğŸ”´</button>
                        <button onclick="selectColor('yellow', 'ğŸŸ¡')" class="mush-icon-btn" data-color="yellow">ğŸŸ¡</button>
                        <button onclick="selectColor('blue', 'ğŸ”µ')" class="mush-icon-btn" data-color="blue">ğŸ”µ</button>
                        <button onclick="selectColor('purple', 'ğŸŸ£')" class="mush-icon-btn" data-color="purple">ğŸŸ£</button>
                        <button onclick="selectColor('white', 'âšª')" class="mush-icon-btn" data-color="white">âšª</button>
                        <button onclick="selectColor('gray', 'ğŸ”˜')" class="mush-icon-btn" data-color="gray">ğŸ”˜</button>
                    </div>
                </div>

                <!-- æ»¾è¼ªå¾®èª¿ -->
                <div class="space-y-3">
                    <div class="flex justify-between items-center px-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ç²¾ç¢ºå¾®èª¿æˆ°é¬¥å‰©é¤˜æ™‚é–“</label>
                        <div class="flex gap-2">
                            <button onclick="adjustWheel('m', 10)" class="text-[10px] bg-brand-50 text-brand-600 dark:bg-brand-900/40 dark:text-brand-300 px-3 py-1.5 rounded-xl font-black active:scale-95">+10åˆ†</button>
                            <button onclick="adjustWheel('s', 10)" class="text-[10px] bg-brand-50 text-brand-600 dark:bg-brand-900/40 dark:text-brand-300 px-3 py-1.5 rounded-xl font-black active:scale-95">+10ç§’</button>
                        </div>
                    </div>
                    <div class="picker-container">
                        <div class="picker-center-indicator"></div>
                        <div id="wheel-h" class="picker-column"></div>
                        <div id="wheel-m" class="picker-column"></div>
                        <div id="wheel-s" class="picker-column"></div>
                    </div>
                </div>

                <button onclick="addMushroom()" class="w-full bg-brand-500 text-white font-black py-6 rounded-4xl shadow-xl shadow-brand-500/20 active:scale-[0.98] transition-all text-xl mt-4">
                    ç¢ºèªè¿½è¹¤ (5åˆ†é‡ç”Ÿ)
                </button>
            </div>
        </div>
    </div>

    <!-- å…¨å±€å¿«è¨Š -->
    <div id="toast" class="fixed top-12 left-1/2 -translate-x-1/2 bg-slate-900/95 dark:bg-white text-white dark:text-slate-900 px-8 py-4 rounded-full shadow-2xl opacity-0 transition-all duration-500 pointer-events-none z-[60] text-sm font-black border border-white/10">å·²å®Œæˆ</div>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        let mushrooms = [];
        let swRegistration = null;
        let wakeLock = null;
        let selectedTime = { h: 0, m: 0, s: 0 };
        let currentMushroomColor = { id: 'red', emoji: 'ğŸ”´' };
        let scrollYBeforeModal = 0;

        // åˆå§‹åŒ–
        window.onload = () => { 
            initDarkMode(); 
            initSW(); 
            initWheels(); 
            loadData(); 
            renderList(); 
            startTicker(); 
        };

        // æ·±è‰²æ¨¡å¼é‚è¼¯
        function initDarkMode() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                updateThemeStyles(true);
            }
        }
        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'theme';
            updateThemeStyles(isDark);
        }
        function updateThemeStyles(isDark) {
            const icon = document.getElementById('dark-icon');
            const meta = document.getElementById('theme-color-meta');
            if (isDark) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M17.657 17.657l.707.707M6.343 6.343l.707-.707M14.5 12a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />';
                meta.setAttribute('content', '#064e3b');
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
                meta.setAttribute('content', '#10b981');
            }
        }

        // PWA Manifest ç”Ÿæˆ
        const manifest = { 
            "name": "è˜‘è‡å¤§å¸« Pro", 
            "short_name": "è˜‘è‡å¤§å¸«", 
            "start_url": ".", 
            "display": "standalone", 
            "background_color": "#f8fafc", 
            "theme_color": "#10b981", 
            "icons": [{ "src": "https://www.pikminbloom.com/favicon.ico", "sizes": "192x192", "type": "image/png" }] 
        };
        document.getElementById('pwa-manifest').setAttribute('href', 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest)));

        // æ»¾è¼ªåˆå§‹åŒ–èˆ‡äº‹ä»¶
        function initWheels() { createWheel('wheel-h', 24, 'h'); createWheel('wheel-m', 60, 'm'); createWheel('wheel-s', 60, 's'); }
        function createWheel(id, count, type) {
            const el = document.getElementById(id);
            let html = '';
            for(let i=0; i<count; i++) html += `<div class="picker-item" data-val="${i}">${String(i).padStart(2, '0')}</div>`;
            el.innerHTML = html;
            el.addEventListener('scroll', () => {
                const index = Math.round(el.scrollTop / 50);
                if (selectedTime[type] !== index && index < count) {
                    selectedTime[type] = index;
                    el.querySelectorAll('.picker-item').forEach((item, i) => item.classList.toggle('active', i === index));
                    if (navigator.vibrate) navigator.vibrate(5);
                }
            }, { passive: true });
        }
        function adjustWheel(type, amount) {
            const el = document.getElementById(`wheel-${type}`);
            const target = (selectedTime[type] + amount) % (type === 'h' ? 24 : 60);
            el.scrollTo({ top: target * 50, behavior: 'smooth' });
        }
        function setPreset(h, m, s) {
            document.getElementById('wheel-h').scrollTo({ top: h * 50, behavior: 'smooth' });
            document.getElementById('wheel-m').scrollTo({ top: m * 50, behavior: 'smooth' });
            document.getElementById('wheel-s').scrollTo({ top: s * 50, behavior: 'smooth' });
            if (navigator.vibrate) navigator.vibrate([10, 50, 10]);
        }

        function selectColor(id, emoji) {
            currentMushroomColor = { id, emoji };
            document.querySelectorAll('.mush-icon-btn').forEach(btn => btn.classList.toggle('selected', btn.dataset.color === id));
            if (navigator.vibrate) navigator.vibrate(10);
        }

        // Service Worker è¨»å†Š
        async function initSW() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', e => self.skipWaiting());
                    self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                    self.addEventListener('notificationclick', e => {
                        e.notification.close();
                        e.waitUntil(clients.matchAll({type: 'window'}).then(c => c.length > 0 ? c[0].focus() : clients.openWindow('/')));
                    });
                `;
                const blob = new Blob([swCode], { type: 'text/javascript' });
                swRegistration = await navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => null);
            }
            updateUIStatus();
        }

        function updateUIStatus() {
            const dot = document.getElementById('pwa-status-dot');
            const txt = document.getElementById('status-text');
            const diag = document.getElementById('diag-card');
            const info = document.getElementById('diag-info');
            if (Notification.permission === "granted") {
                dot.className = "w-2 h-2 rounded-full bg-green-400 shadow-[0_0_8px_#4ade80]";
                txt.innerText = swRegistration ? "èƒŒæ™¯ç›£æ§é‹ä½œä¸­" : "å‰å°ç›£æ§ä¸­";
                diag.classList.add('hidden');
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-400 animate-pulse";
                txt.innerText = "é€šçŸ¥æœªå•Ÿå‹•";
                diag.classList.remove('hidden');
                info.innerText = "â„¹ï¸ è«‹é»æ“ŠæŒ‰éˆ•æˆæ¬Šé€šçŸ¥ï¼Œç³»çµ±å°‡åœ¨é‡ç”Ÿå‰ 20 ç§’æé†’ã€‚";
            }
        }

        function toggleDiag() { document.getElementById('diag-card').classList.toggle('hidden'); }

        async function requestNotificationPermission() {
            const p = await Notification.requestPermission();
            updateUIStatus();
            if (p === "granted") showToast("âœ… é€šçŸ¥åŠŸèƒ½å·²å•Ÿç”¨");
        }

        // è³‡æ–™è™•ç†æ ¸å¿ƒ
        function addMushroom() {
            const labelInput = document.getElementById('input-label').value.trim();
            const label = labelInput || `${currentMushroomColor.id}è˜‘è‡`;
            const { h, m, s } = selectedTime;
            // è¨ˆç®—ï¼šè¼¸å…¥æ™‚é–“ + 300 ç§’ (5 åˆ†é˜)
            const waitSec = (h * 3600) + (m * 60) + s + 300;
            const spawnAt = Date.now() + (waitSec * 1000);

            mushrooms.push({ 
                id: Date.now(), 
                label, 
                iconEmoji: currentMushroomColor.emoji, 
                spawnAt, 
                createdAt: Date.now(), 
                notified: false 
            });
            saveData(); renderList(); toggleAddModal();
            showToast(`ğŸš€ å·²å•Ÿå‹•ï¼š${currentMushroomColor.emoji} ${label}`);
            requestWakeLock();
        }

        function renderList() {
            const container = document.getElementById('mushroom-list');
            const empty = document.getElementById('empty-state');
            if (mushrooms.length === 0) { empty.classList.remove('hidden'); container.innerHTML = ""; return; }
            empty.classList.add('hidden');
            
            mushrooms.sort((a,b) => a.spawnAt - b.spawnAt);
            container.innerHTML = mushrooms.map(m => {
                const now = Date.now();
                const isOver = now > m.spawnAt;
                const total = m.spawnAt - m.createdAt;
                const elapsed = now - m.createdAt;
                const progress = isOver ? 100 : Math.min(100, Math.max(0, (elapsed / total) * 100));
                
                return `
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-4xl premium-shadow relative overflow-hidden card-enter border border-slate-100 dark:border-slate-800">
                        <div class="absolute left-0 top-0 bottom-0 w-1.5" style="background: ${getHex(m.iconEmoji)}"></div>
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">${m.iconEmoji}</span>
                                <div>
                                    <h3 class="font-black text-slate-800 dark:text-white text-lg leading-tight truncate max-w-[150px]">${m.label}</h3>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">é‡ç”Ÿæ™‚åˆ» ${new Date(m.spawnAt).toLocaleTimeString('zh-TW', {hour12:false})}</p>
                                </div>
                            </div>
                            <button onclick="deleteMushroom(${m.id})" class="w-10 h-10 bg-slate-50 dark:bg-slate-800 text-slate-300 rounded-2xl flex items-center justify-center active:scale-90 font-bold">âœ•</button>
                        </div>
                        
                        <!-- é€²åº¦æ¢ -->
                        <div class="w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden mb-4 relative">
                            <div id="pb-${m.id}" class="h-full transition-all duration-1000 ease-linear relative ${isOver ? 'bg-slate-300' : ''}" 
                                 style="width: ${progress}%; background-color: ${isOver ? '' : getHex(m.iconEmoji)}">
                                 <div class="absolute inset-0 progress-shimmer opacity-30"></div>
                            </div>
                        </div>

                        <div class="flex items-end justify-between">
                            <span id="t-${m.id}" class="font-mono text-4xl font-black ${isOver ? 'text-slate-200 dark:text-slate-800' : 'text-brand-500'} tracking-tighter">
                                ${getRemaining(m.spawnAt)}
                            </span>
                            <span class="text-[10px] font-black ${isOver ? 'text-slate-300' : 'text-slate-400'} uppercase pb-1 tracking-widest">${isOver ? 'FINISHED' : 'COUNTDOWN'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getHex(emoji) { const colors = { 'ğŸ”´':'#ef4444', 'ğŸŸ¡':'#fbbf24', 'ğŸ”µ':'#3b82f6', 'ğŸŸ£':'#a855f7', 'âšª':'#cbd5e1', 'ğŸ”˜':'#64748b' }; return colors[emoji] || '#10b981'; }
        
        function getRemaining(target) {
            const diff = target - Date.now();
            if (diff <= 0) return "00:00:00";
            const s = Math.floor(diff / 1000);
            return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
        }

        // å®šæ™‚å™¨é‚è¼¯
        function startTicker() {
            setInterval(() => {
                const now = Date.now();
                mushrooms.forEach(m => {
                    const tEl = document.getElementById(`t-${m.id}`);
                    const pEl = document.getElementById(`pb-${m.id}`);
                    if (tEl) tEl.innerText = getRemaining(m.spawnAt);
                    
                    // ä¿®æ­£ Bug: ç¢ºä¿ç¾åœ¨æ™‚é–“å°æ–¼é‡ç”Ÿæ™‚é–“æ‰æ›´æ–°é€²åº¦æ¢
                    if (pEl && now < m.spawnAt) {
                        const total = m.spawnAt - m.createdAt;
                        const elapsed = now - m.createdAt;
                        pEl.style.width = Math.min(100, Math.max(0, (elapsed / total) * 100)) + '%';
                    } else if (pEl) {
                        pEl.style.width = '100%';
                    }

                    // 20 ç§’æå‰é€šçŸ¥é‚è¼¯
                    if (!m.notified && (m.spawnAt - now) <= 20000 && (m.spawnAt - now) > 0) {
                        m.notified = true; triggerNotification(m); saveData();
                    }
                });
            }, 1000);
        }

        function triggerNotification(m, isTest = false) {
            const title = isTest ? "ğŸ„ é€šçŸ¥æ¸¬è©¦æˆåŠŸ" : `${m.iconEmoji} è˜‘è‡å³å°‡é‡ç”Ÿï¼`;
            const body = isTest ? "é€šçŸ¥åŠŸèƒ½æ­£å¸¸é‹ä½œä¸­ã€‚" : `${m.label} é‡ç”Ÿå€’æ•¸ 20 ç§’ï¼Œè«‹é–‹å•ŸéŠæˆ²æº–å‚™ã€‚`;
            const sound = document.getElementById('notif-sound');
            if (sound) { sound.currentTime = 0; sound.play().catch(() => {}); }
            if (Notification.permission === "granted") {
                if (swRegistration && swRegistration.showNotification) swRegistration.showNotification(title, { body, icon: "https://www.pikminbloom.com/favicon.ico", vibrate: [200, 100, 200] });
                else try { new Notification(title, { body }); } catch (e) {}
            }
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }

        // PWA èˆ‡ç³»çµ±åŠŸèƒ½
        async function requestWakeLock() { if ('wakeLock' in navigator && mushrooms.some(m => m.spawnAt > Date.now())) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {} } }
        
        function toggleAddModal() {
            const modal = document.getElementById('add-modal');
            const isClosing = !modal.classList.contains('hidden');
            
            if (!isClosing) {
                scrollYBeforeModal = window.scrollY;
                modal.classList.remove('hidden');
                setTimeout(() => document.body.classList.add('modal-active'), 10);
                document.body.classList.add('modal-open');
                document.body.style.top = `-${scrollYBeforeModal}px`;
            } else {
                document.body.classList.remove('modal-active');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                    document.body.style.top = '';
                    window.scrollTo(0, scrollYBeforeModal);
                }, 400);
            }
        }

        function deleteMushroom(id) { mushrooms = mushrooms.filter(m => m.id !== id); saveData(); renderList(); }
        function saveData() { localStorage.setItem('pm_ultra_v5', JSON.stringify(mushrooms)); }
        function loadData() { 
            const d = localStorage.getItem('pm_ultra_v5') || localStorage.getItem('pm_ultra_data') || localStorage.getItem('pm_v4_data'); 
            if (d) { try { mushrooms = JSON.parse(d).filter(m => m.spawnAt > (Date.now() - 86400000)); } catch(e) { mushrooms = []; } } 
        }
        function showToast(m) { 
            const t = document.getElementById('toast'); t.innerText = m; 
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 15px)'; 
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 0)'; }, 3000); 
        }

        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') requestWakeLock(); });
    </script>
</body>
</html>
