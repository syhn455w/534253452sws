<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>çš®å…‹æ•è˜‘è‡ PWA</title>
    
    <!-- PWA å…ƒè³‡æ–™ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#16a34a">
    <link rel="apple-touch-icon" href="https://www.pikminbloom.com/favicon.ico">
    <link rel="manifest" id="pwa-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root { --safe-area-inset-top: env(safe-area-inset-top); }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            padding-top: var(--safe-area-inset-top);
        }
        .app-gradient { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .card-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* é‡å° iOS åº•éƒ¨æ©«æ¢å„ªåŒ– */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
    <header class="app-gradient text-white px-6 pt-8 pb-12 rounded-b-[3.5rem] shadow-2xl sticky top-0 z-40">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black tracking-tight flex items-center gap-2">
                    <span class="text-3xl">ğŸ„</span> çš®å…‹æ•è¨ˆæ™‚
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="pwa-status" class="w-2 h-2 rounded-full bg-red-400"></span>
                    <p id="status-text" class="text-green-100 text-xs font-medium opacity-80">é€šçŸ¥æœªå°±ç·’</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="testNotification()" class="bg-white/10 p-3 rounded-2xl text-white active:scale-90 transition-all border border-white/20" title="æ¸¬è©¦é€šçŸ¥">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                </button>
                <button onclick="toggleAddModal()" class="bg-white text-green-600 p-3 rounded-2xl shadow-xl active:scale-90 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 -mt-8 space-y-4">
        
        <!-- PWA å®‰è£æé†’ -->
        <div id="pwa-install-banner" class="hidden bg-indigo-600 text-white p-5 rounded-[2rem] shadow-xl flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="text-3xl">ğŸ“±</div>
                <div class="text-xs font-bold leading-tight">å®‰è£åˆ°ä¸»ç•«é¢<br><span class="opacity-80 font-normal">æ‰èƒ½åœ¨é–å®šè¢å¹•æ”¶é€šçŸ¥</span></div>
            </div>
            <button id="install-button" class="bg-white text-indigo-600 px-5 py-2 rounded-full text-xs font-black">ç«‹å³å®‰è£</button>
        </div>

        <!-- æ¬Šé™è¨ºæ–·å€ -->
        <div id="diag-banner" class="bg-white p-4 rounded-[2rem] shadow-sm border border-gray-100 space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-xs font-black text-gray-400 uppercase tracking-widest">é€šçŸ¥èˆ‡èƒŒæ™¯è¨ºæ–·</span>
                <span id="perm-label" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">æª¢æŸ¥ä¸­</span>
            </div>
            
            <!-- éŒ¯èª¤æç¤ºï¼šç•¶ Service Worker ç„¡æ³•é‹ä½œæ™‚ -->
            <div id="sw-error-msg" class="hidden bg-amber-50 p-3 rounded-2xl border border-amber-100">
                <p class="text-[10px] text-amber-700 leading-relaxed">
                    â„¹ï¸ <b>èƒŒæ™¯é‹è¡Œå—é™</b>ï¼šç•¶å‰ç’°å¢ƒä¸æ”¯æ´èƒŒæ™¯é€šçŸ¥ã€‚è«‹å°‡æ­¤ç¶²é éƒ¨ç½²åˆ° <b>GitHub Pages (HTTPS)</b> ä¸¦åœ¨æ‰‹æ©Ÿä¸Šã€ŒåŠ å…¥ä¸»ç•«é¢ã€ä»¥è§£é–å®Œæ•´åŠŸèƒ½ã€‚
                </p>
            </div>

            <div id="diag-warning" class="hidden bg-red-50 p-3 rounded-2xl border border-red-100">
                <p class="text-[10px] text-red-600 leading-relaxed font-bold">
                    âš ï¸ åµæ¸¬åˆ°é€šçŸ¥é­é˜»æ“‹ï¼è«‹æª¢æŸ¥ï¼š<br>
                    1. ç¶²å€åˆ—æ—çš„ã€Œæ¬Šé™è¨­å®šã€æ˜¯å¦å…è¨±é€šçŸ¥ã€‚<br>
                    2. ç³»çµ±ã€Œå‹¿æ“¾æ¨¡å¼ã€æ˜¯å¦é—œé–‰ã€‚<br>
                    3. ç³»çµ±è¨­å®š > é€šçŸ¥ > æ˜¯å¦å…è¨±ç€è¦½å™¨é¡¯ç¤ºæ©«å¹…ã€‚
                </p>
            </div>
            <button onclick="requestNotificationPermission()" id="perm-btn" class="w-full bg-blue-600 text-white py-3 rounded-2xl text-xs font-bold shadow-md active:scale-95 transition-all">
                é»æ­¤æˆæ¬Šé€šçŸ¥æ¬Šé™
            </button>
        </div>

        <!-- æ¸…å–® -->
        <div id="empty-state" class="py-24 text-center space-y-4 opacity-30">
            <div class="text-6xl">ğŸ„</div>
            <p class="text-gray-500 font-bold">ç›®å‰æ²’æœ‰è¿½è¹¤ä¸­çš„è˜‘è‡</p>
        </div>

        <div id="mushroom-list" class="grid gap-4"></div>

    </main>

    <!-- æ–°å¢å½ˆçª— -->
    <div id="add-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-black/70 backdrop-blur-md hidden">
        <div class="bg-white w-full max-w-md rounded-[3rem] p-8 space-y-6 shadow-2xl transition-all mb-safe">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black text-gray-800">æ–°å¢è˜‘è‡åœ°é»</h2>
                <button onclick="toggleAddModal()" class="text-gray-300 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="input-label" placeholder="ä¾‹å¦‚ï¼šå®¶é–€å£ã€ç´…è˜‘è‡" class="w-full p-5 bg-gray-50 border-2 border-transparent rounded-3xl focus:border-green-500 focus:bg-white outline-none transition-all font-bold">
                <div class="grid grid-cols-3 gap-3">
                    <div class="text-center"><p class="text-[10px] text-gray-400 font-bold mb-1">æ™‚</p><input type="number" id="input-h" placeholder="0" class="w-full text-center p-5 bg-gray-50 rounded-3xl focus:bg-green-50 outline-none font-black text-lg"></div>
                    <div class="text-center"><p class="text-[10px] text-gray-400 font-bold mb-1">åˆ†</p><input type="number" id="input-m" placeholder="0" class="w-full text-center p-5 bg-gray-50 rounded-3xl focus:bg-green-50 outline-none font-black text-lg"></div>
                    <div class="text-center"><p class="text-[10px] text-gray-400 font-bold mb-1">ç§’</p><input type="number" id="input-s" placeholder="0" class="w-full text-center p-5 bg-gray-50 rounded-3xl focus:bg-green-50 outline-none font-black text-lg"></div>
                </div>
                <button onclick="addMushroom()" class="w-full bg-green-600 text-white font-black py-5 rounded-[2rem] shadow-xl active:scale-95 transition-all text-lg">é–‹å§‹è¨ˆæ™‚ (15åˆ†é‡ç”Ÿ)</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-900/90 text-white px-8 py-3 rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-50 text-sm font-bold">å·²æ›´æ–°</div>

    <!-- æç¤ºéŸ³æ•ˆ -->
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        let mushrooms = [];
        let swRegistration = null;
        let wakeLock = null;

        // 1. PWA Manifest
        const manifest = {
            "name": "çš®å…‹æ•è˜‘è‡è¨ˆæ™‚å™¨",
            "short_name": "çš®å…‹æ•è¨ˆæ™‚",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f8fafc",
            "theme_color": "#16a34a",
            "icons": [{ "src": "https://www.pikminbloom.com/favicon.ico", "sizes": "192x192", "type": "image/png" }]
        };
        document.getElementById('pwa-manifest').setAttribute('href', 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest)));

        // 2. åˆå§‹åŒ– Service Worker (ä¿®æ­£ blob è¨»å†Šå•é¡Œ)
        async function initSW() {
            if ('serviceWorker' in navigator) {
                try {
                    const swCode = `
                        self.addEventListener('install', e => self.skipWaiting());
                        self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                        self.addEventListener('notificationclick', e => {
                            e.notification.close();
                            e.waitUntil(clients.matchAll({type: 'window'}).then(c => c.length > 0 ? c[0].focus() : clients.openWindow('/')));
                        });
                    `;
                    const blob = new Blob([swCode], { type: 'text/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    
                    // å˜—è©¦è¨»å†Š Service Worker
                    swRegistration = await navigator.serviceWorker.register(swUrl).catch(err => {
                        // æ“·å–ä¸¦è™•ç†è¨»å†Šå¤±æ•— (å¦‚å”å®šä¸æ”¯æŒ)
                        console.warn("Service Worker è¨»å†Šè¢«æ””æˆª (é€šå¸¸ç™¼ç”Ÿåœ¨æ²™ç›’é è¦½ç’°å¢ƒ):", err);
                        document.getElementById('sw-error-msg').classList.remove('hidden');
                        return null;
                    });
                    
                    if (swRegistration) {
                        console.log("Service Worker è¨»å†ŠæˆåŠŸ");
                    }
                } catch (e) { 
                    console.error("SW åˆå§‹åŒ–ç•°å¸¸:", e);
                }
            } else {
                console.log("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Service Worker");
            }
            updateUIStatus();
        }

        function updateUIStatus() {
            const statusDot = document.getElementById('pwa-status');
            const statusText = document.getElementById('status-text');
            const permLabel = document.getElementById('perm-label');
            const diagWarning = document.getElementById('diag-warning');
            const permBtn = document.getElementById('perm-btn');

            if (Notification.permission === "granted") {
                statusDot.className = "w-2 h-2 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]";
                statusText.innerText = swRegistration ? "é€šçŸ¥å·²å°±ç·’" : "å‰å°é€šçŸ¥å°±ç·’";
                permLabel.innerText = "å·²æˆæ¬Š";
                permLabel.className = "text-[10px] font-bold px-2 py-0.5 rounded-full bg-green-100 text-green-600";
                diagWarning.classList.add('hidden');
                permBtn.classList.add('hidden');
            } else {
                statusDot.className = "w-2 h-2 rounded-full bg-red-400 animate-pulse";
                statusText.innerText = "é»æ­¤é–‹å•Ÿé€šçŸ¥";
                permLabel.innerText = Notification.permission === "denied" ? "æ¬Šé™è¢«æ‹’çµ•" : "å°šæœªæˆæ¬Š";
                permLabel.className = "text-[10px] font-bold px-2 py-0.5 rounded-full bg-red-100 text-red-600";
                if (Notification.permission === "denied") diagWarning.classList.remove('hidden');
                permBtn.classList.remove('hidden');
            }
        }

        async function requestNotificationPermission() {
            const p = await Notification.requestPermission();
            updateUIStatus();
            if (p === "granted") {
                showToast("é€šçŸ¥æ¬Šé™å·²é–‹å•Ÿ");
                testNotification(); 
            }
        }

        function testNotification() {
            if (Notification.permission !== "granted") {
                showToast("è«‹å…ˆé»æ“Šä¸‹æ–¹æŒ‰éˆ•æˆæ¬Š");
                return;
            }
            showToast("æ­£åœ¨å˜—è©¦ç™¼é€æ¸¬è©¦é€šçŸ¥...");
            triggerNotification({ label: "æ¸¬è©¦æé†’", id: "test", spawnAt: Date.now() }, true);
        }

        function addMushroom() {
            const label = document.getElementById('input-label').value || "æœªçŸ¥åœ°é»";
            const h = parseInt(document.getElementById('input-h').value) || 0;
            const m = parseInt(document.getElementById('input-m').value) || 0;
            const s = parseInt(document.getElementById('input-s').value) || 0;

            if (h===0 && m===0 && s===0) return showToast("è«‹è¼¸å…¥å‰©é¤˜æˆ°é¬¥æ™‚é–“");

            const waitSec = (h * 3600) + (m * 60) + s + 900;
            const spawnAt = Date.now() + (waitSec * 1000);

            mushrooms.push({ id: Date.now(), label, spawnAt, notified: false });
            saveData();
            renderList();
            toggleAddModal();
            showToast(`å·²è¨­å®šï¼š${label}`);
            
            ['input-label','input-h','input-m','input-s'].forEach(id => document.getElementById(id).value = "");
            requestWakeLock();
        }

        function triggerNotification(m, isTest = false) {
            const title = isTest ? "ğŸ„ é€šçŸ¥æ¸¬è©¦" : "ğŸ„ è˜‘è‡é‡ç”Ÿæé†’";
            const body = isTest ? "è‹¥çœ‹åˆ°æ­¤è¨Šæ¯ï¼Œä»£è¡¨é€šçŸ¥åŠŸèƒ½æ­£å¸¸ï¼" : `${m.label} å³å°‡åœ¨ 15 ç§’å¾Œé‡ç”Ÿã€‚`;
            const icon = "https://www.pikminbloom.com/favicon.ico";

            // è²éŸ³è£œå„Ÿ
            const sound = document.getElementById('notif-sound');
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(() => console.log("è²éŸ³æ’­æ”¾éœ€è¦ä½¿ç”¨è€…å…ˆèˆ‡é é¢äº’å‹•"));
            }

            // è¦–è¦ºèˆ‡éœ‡å‹•
            if (Notification.permission === "granted") {
                if (swRegistration && swRegistration.showNotification) {
                    swRegistration.showNotification(title, { body, icon, vibrate: [200, 100, 200], tag: m.id });
                } else {
                    // é€€å›åˆ°æ¨™æº– Web Notification API
                    try {
                        new Notification(title, { body, icon });
                    } catch (e) {
                        console.warn("ç„¡æ³•å•Ÿå‹•è¦–è¦ºé€šçŸ¥:", e);
                    }
                }
            }
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }

        function renderList() {
            const container = document.getElementById('mushroom-list');
            const empty = document.getElementById('empty-state');
            if (mushrooms.length === 0) { empty.classList.remove('hidden'); container.innerHTML = ""; return; }
            empty.classList.add('hidden');

            mushrooms.sort((a,b) => a.spawnAt - b.spawnAt);
            container.innerHTML = mushrooms.map(m => {
                const isOver = Date.now() > m.spawnAt;
                return `
                    <div class="glass-card p-6 rounded-[2.5rem] shadow-sm relative overflow-hidden card-enter">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] px-3 py-1 rounded-full font-black ${isOver ? 'bg-gray-100 text-gray-400' : 'bg-green-100 text-green-700'}">
                                ${isOver ? 'å·²çµæŸ' : 'ç›£æ§ä¸­'}
                            </span>
                            <button onclick="deleteMushroom(${m.id})" class="text-gray-300 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                        </div>
                        <h3 class="font-black text-gray-800 text-xl truncate pr-10">${m.label}</h3>
                        <p class="text-xs font-bold text-gray-400 mt-1">é‡ç”Ÿæ™‚åˆ»ï¼š${new Date(m.spawnAt).toLocaleTimeString('zh-TW', {hour12:false})}</p>
                        <div class="mt-4">
                            <span id="t-${m.id}" class="font-mono text-4xl font-black ${isOver ? 'text-gray-200' : 'text-red-500'} tracking-tighter">
                                ${getRemaining(m.spawnAt)}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getRemaining(target) {
            const diff = target - Date.now();
            if (diff <= 0) return "REBORN";
            const s = Math.floor(diff / 1000);
            return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
        }

        function startTicker() {
            setInterval(() => {
                const now = Date.now();
                mushrooms.forEach(m => {
                    const el = document.getElementById(`t-${m.id}`);
                    if (el) el.innerText = getRemaining(m.spawnAt);
                    if (!m.notified && (m.spawnAt - now) <= 15000 && (m.spawnAt - now) > 0) {
                        m.notified = true;
                        triggerNotification(m);
                        saveData();
                    }
                });
            }, 1000);
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator && mushrooms.some(m => m.spawnAt > Date.now())) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
            }
        }

        function toggleAddModal() { document.getElementById('add-modal').classList.toggle('hidden'); }
        function deleteMushroom(id) { mushrooms = mushrooms.filter(m => m.id !== id); saveData(); renderList(); }
        function saveData() { localStorage.setItem('pm_v3_data', JSON.stringify(mushrooms)); }
        function loadData() {
            const d = localStorage.getItem('pm_v3_data');
            if (d) {
                try {
                    mushrooms = JSON.parse(d).filter(m => m.spawnAt > (Date.now() - 86400000));
                } catch(e) { mushrooms = []; }
            }
        }
        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        }

        window.onload = () => { initSW(); loadData(); renderList(); startTicker(); };
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') requestWakeLock(); });
    </script>
</body>
</html>
